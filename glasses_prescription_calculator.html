<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁúºÈè°Âá¶ÊñπË®àÁÆó„ÉÑ„Éº„É´ - Âä†ÂÖ•Â∫¶Êï∞ÂØæÂøúÂÆåÂÖ®Áâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
        .number-input-group {
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        .long-press-button {
            transition: all 0.15s ease;
        }
        .long-press-button:active {
            transform: scale(0.95);
        }
        .prescription-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-4">
    <div class="max-w-7xl mx-auto">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <div class="p-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl shadow-lg">
                    <div class="w-8 h-8 text-white flex items-center justify-center text-2xl">üëÅÔ∏è</div>
                </div>
            </div>
            <h1 class="text-4xl font-bold text-blue-600 mb-2">
                ÁúºÈè°Âá¶ÊñπË®àÁÆó„ÉÑ„Éº„É´ - Âä†ÂÖ•Â∫¶Êï∞ÂØæÂøúÂÆåÂÖ®Áâà
            </h1>
            <p class="text-gray-600">È´òÁ≤æÂ∫¶Âá¶ÊñπË®àÁÆó„ÉªÂ±•Ê≠¥‰øùÂ≠ò„ÉªË©≥Á¥∞ÂàÜÊûê„ÉªADDÂØæÂøúÊ©üËÉΩÊê≠Ëºâ</p>
            <div class="mt-2 text-xs text-gray-500">
                ‰π±Ë¶ñËª∏ÊñπÂêëÂà•Âá¶ÊñπÊ≥ïÂâá„ÉªÂπ¥ÈΩ¢Âà•ÊÖ£„ÇåÂà∂Èôê„Éª‰∏çÂêåË¶ñÂØæÂøú„ÉªKB„Åã„Çâ„ÅÆÂ§âÂåñÈáèË°®Á§∫„ÉªÂá¶ÊñπÂ±•Ê≠¥‰øùÂ≠ò„ÉªÂä†ÂÖ•Â∫¶Êï∞ÂØæÂøú
            </div>
            <!-- „ÉÑ„Éº„É´„Éú„Çø„É≥ -->
            <div class="flex justify-center space-x-4 mt-4">
                <button onclick="toggleHistory()" class="px-4 py-2 bg-gradient-to-r from-indigo-400 to-purple-500 text-white rounded-xl shadow-lg hover:shadow-xl transition-all">
                    üìä Â±•Ê≠¥Ë°®Á§∫
                </button>
                <button onclick="clearAllData()" class="px-4 py-2 bg-gradient-to-r from-red-400 to-pink-500 text-white rounded-xl shadow-lg hover:shadow-xl transition-all">
                    üóëÔ∏è ÂÖ®ÂâäÈô§
                </button>
            </div>
        </div>

        <!-- Â±•Ê≠¥Ë°®Á§∫„Éë„Éç„É´ -->
        <div id="historyPanel" class="hidden mb-8">
            <div class="prescription-card rounded-3xl shadow-xl p-6 border border-purple-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <span class="mr-2">üìã</span>Âá¶ÊñπÂ±•Ê≠¥
                    </h2>
                    <button onclick="toggleHistory()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>
                <div id="historyContent" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Â±•Ê≠¥ÂÜÖÂÆπ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Â∑¶„Ç´„É©„É† - ÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
            <div class="space-y-6">
                <!-- Âü∫Êú¨ÊÉÖÂ†± -->
                <div class="prescription-card rounded-3xl shadow-xl p-6 border border-blue-100">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-gradient-to-r from-blue-400 to-cyan-400 rounded-lg mr-3">
                            <div class="w-5 h-5 text-white flex items-center justify-center">üë•</div>
                        </div>
                        <h2 class="text-xl font-semibold">Âü∫Êú¨ÊÉÖÂ†±</h2>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Âπ¥ÈΩ¢</label>
                            <input
                                type="number"
                                min="10"
                                max="100"
                                id="age"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="10-100Ê≠≥"
                                onchange="updateAgeBasedAddPower()"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÊÇ£ËÄÖÂêçÔºà‰ªªÊÑèÔºâ</label>
                            <input
                                type="text"
                                id="patientName"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Áî∞‰∏≠Â§™ÈÉé"
                            />
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰∏ªË®¥ÔºàÈÅ∏ÊäûÈ†Ü„ÅßA‚ÜíB‚ÜíCÔºâ</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="complaint1" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm flex-1">ÈÅ†ÊñπË¶ñÂäõ‰Ωé‰∏ã</span>
                                <span id="priority1" class="w-6 h-6 rounded-full text-xs font-bold items-center justify-center text-white hidden"></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="complaint2" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm flex-1">ËøëÊñπË¶ñÂäõ‰Ωé‰∏ã</span>
                                <span id="priority2" class="w-6 h-6 rounded-full text-xs font-bold items-center justify-center text-white hidden"></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="complaint3" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm flex-1">ÁúºÁ≤æÁñ≤Âä¥</span>
                                <span id="priority3" class="w-6 h-6 rounded-full text-xs font-bold items-center justify-center text-white hidden"></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="complaint4" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm flex-1">„Éî„É≥„ÉàÂêà„Çè„ÅõÂõ∞Èõ£</span>
                                <span id="priority4" class="w-6 h-6 rounded-full text-xs font-bold items-center justify-center text-white hidden"></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="complaint5" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm flex-1">È†≠Áóõ„ÉªËÇ©„Åì„Çä</span>
                                <span id="priority5" class="w-6 h-6 rounded-full text-xs font-bold items-center justify-center text-white hidden"></span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="complaint6" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm flex-1">Â§úÈñìÈÅãËª¢Âõ∞Èõ£</span>
                                <span id="priority6" class="w-6 h-6 rounded-full text-xs font-bold items-center justify-center text-white hidden"></span>
                            </label>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁîüÊ¥ªÊßòÂºè</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="lifestyle1" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm">üöó ÈÅãËª¢</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="lifestyle2" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm">üíª „Éá„Çπ„ÇØ„ÉØ„Éº„ÇØ</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="lifestyle3" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm">üìö Ë™≠Êõ∏</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="lifestyle4" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm">‚öΩ „Çπ„Éù„Éº„ÉÑ</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="lifestyle5" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm">üè† ÂÆ∂‰∫ã</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="lifestyle6" class="rounded text-blue-600 focus:ring-blue-500" />
                                <span class="text-sm">üßµ ÊâãËä∏</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Ë£∏ÁúºË¶ñÂäõ -->
                <div class="prescription-card rounded-3xl shadow-xl p-6 border border-green-100">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-gradient-to-r from-green-400 to-emerald-400 rounded-lg mr-3">
                            <div class="w-5 h-5 text-white flex items-center justify-center">üëÅÔ∏è</div>
                        </div>
                        <h2 class="text-xl font-semibold">Ë£∏ÁúºË¶ñÂäõ</h2>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Âè≥Áúº</label>
                            <select id="nakedVisionRight" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">ÈÅ∏Êäû</option>
                                <option value="0.1">0.1</option>
                                <option value="0.2">0.2</option>
                                <option value="0.3">0.3</option>
                                <option value="0.4">0.4</option>
                                <option value="0.5">0.5</option>
                                <option value="0.6">0.6</option>
                                <option value="0.7">0.7</option>
                                <option value="0.8">0.8</option>
                                <option value="0.9">0.9</option>
                                <option value="1.0">1.0</option>
                                <option value="1.2">1.2</option>
                                <option value="1.5">1.5</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∑¶Áúº</label>
                            <select id="nakedVisionLeft" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">ÈÅ∏Êäû</option>
                                <option value="0.1">0.1</option>
                                <option value="0.2">0.2</option>
                                <option value="0.3">0.3</option>
                                <option value="0.4">0.4</option>
                                <option value="0.5">0.5</option>
                                <option value="0.6">0.6</option>
                                <option value="0.7">0.7</option>
                                <option value="0.8">0.8</option>
                                <option value="0.9">0.9</option>
                                <option value="1.0">1.0</option>
                                <option value="1.2">1.2</option>
                                <option value="1.5">1.5</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ÁèæÁî®ÁúºÈè° (KB) -->
                <div class="prescription-card rounded-3xl shadow-xl p-6 border border-indigo-100">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-gradient-to-r from-indigo-400 to-purple-400 rounded-lg mr-3">
                            <div class="w-5 h-5 text-white flex items-center justify-center">üìä</div>
                        </div>
                        <h2 class="text-xl font-semibold">ÁèæÁî®ÁúºÈè° (KB)</h2>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="hasKB" class="rounded text-indigo-600 focus:ring-indigo-500" />
                            <span class="text-sm font-medium">ÁèæÁî®ÁúºÈè°„ÅÇ„Çä</span>
                        </label>
                    </div>

                    <div id="kbSection" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‰ΩøÁî®Âπ¥Êï∞</label>
                            <input
                                type="number"
                                min="0"
                                max="10"
                                id="kbUsageYears"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="0-10Âπ¥"
                            />
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">Âè≥Áúº</h3>
                            <div class="grid grid-cols-5 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">SPH</label>
                                    <div class="number-input-container" data-field="kbRightSph">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-20" max="20" id="kbRightSph" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="SPH" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">CYL</label>
                                    <div class="number-input-container" data-field="kbRightCyl">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-6" max="0" id="kbRightCyl" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="CYL" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">AXIS</label>
                                    <div class="flex items-center space-x-1">
                                        <button type="button" onclick="adjustAxis('kbRightAxis', -5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" min="0" max="180" step="5" id="kbRightAxis" class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="AXIS" />
                                        <button type="button" onclick="adjustAxis('kbRightAxis', 5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">ADD</label>
                                    <div class="number-input-container" data-field="kbRightAdd">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="0" max="3" id="kbRightAdd" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ADD" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">Ë¶ñÂäõ</label>
                                    <select id="kbRightVision" class="w-full px-2 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="">ÈÅ∏Êäû</option>
                                        <option value="0.1">0.1</option>
                                        <option value="0.2">0.2</option>
                                        <option value="0.3">0.3</option>
                                        <option value="0.4">0.4</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.6">0.6</option>
                                        <option value="0.7">0.7</option>
                                        <option value="0.8">0.8</option>
                                        <option value="0.9">0.9</option>
                                        <option value="1.0">1.0</option>
                                        <option value="1.2">1.2</option>
                                        <option value="1.5">1.5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">Â∑¶Áúº</h3>
                            <div class="grid grid-cols-5 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">SPH</label>
                                    <div class="number-input-container" data-field="kbLeftSph">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-20" max="20" id="kbLeftSph" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="SPH" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">CYL</label>
                                    <div class="number-input-container" data-field="kbLeftCyl">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-6" max="0" id="kbLeftCyl" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="CYL" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">AXIS</label>
                                    <div class="flex items-center space-x-1">
                                        <button type="button" onclick="adjustAxis('kbLeftAxis', -5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" min="0" max="180" step="5" id="kbLeftAxis" class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="AXIS" />
                                        <button type="button" onclick="adjustAxis('kbLeftAxis', 5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">ADD</label>
                                    <div class="number-input-container" data-field="kbLeftAdd">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="0" max="3" id="kbLeftAdd" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ADD" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">Ë¶ñÂäõ</label>
                                    <select id="kbLeftVision" class="w-full px-2 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="">ÈÅ∏Êäû</option>
                                        <option value="0.1">0.1</option>
                                        <option value="0.2">0.2</option>
                                        <option value="0.3">0.3</option>
                                        <option value="0.4">0.4</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.6">0.6</option>
                                        <option value="0.7">0.7</option>
                                        <option value="0.8">0.8</option>
                                        <option value="0.9">0.9</option>
                                        <option value="1.0">1.0</option>
                                        <option value="1.2">1.2</option>
                                        <option value="1.5">1.5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „É¨„ÉïÂÄ§ -->
                <div class="prescription-card rounded-3xl shadow-xl p-6 border border-purple-100">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-gradient-to-r from-purple-400 to-pink-400 rounded-lg mr-3">
                            <div class="w-5 h-5 text-white flex items-center justify-center">üßÆ</div>
                        </div>
                        <h2 class="text-xl font-semibold">„É¨„ÉïÂÄ§</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">Âè≥Áúº</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">SPH</label>
                                    <div class="number-input-container" data-field="refRightSph">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-20" max="20" id="refRightSph" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="SPH" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">CYL</label>
                                    <div class="number-input-container" data-field="refRightCyl">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-6" max="0" id="refRightCyl" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="CYL" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">AXIS</label>
                                    <div class="flex items-center space-x-1">
                                        <button type="button" onclick="adjustAxis('refRightAxis', -5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" min="0" max="180" step="5" id="refRightAxis" class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="AXIS" />
                                        <button type="button" onclick="adjustAxis('refRightAxis', 5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">Â∑¶Áúº</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">SPH</label>
                                    <div class="number-input-container" data-field="refLeftSph">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-20" max="20" id="refLeftSph" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="SPH" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">CYL</label>
                                    <div class="number-input-container" data-field="refLeftCyl">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-6" max="0" id="refLeftCyl" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="CYL" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">AXIS</label>
                                    <div class="flex items-center space-x-1">
                                        <button type="button" onclick="adjustAxis('refLeftAxis', -5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" min="0" max="180" step="5" id="refLeftAxis" class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="AXIS" />
                                        <button type="button" onclick="adjustAxis('refLeftAxis', 5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§ -->
                <div class="prescription-card rounded-3xl shadow-xl p-6 border border-orange-100">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-gradient-to-r from-orange-400 to-red-400 rounded-lg mr-3">
                            <div class="w-5 h-5 text-white flex items-center justify-center">üéØ</div>
                        </div>
                        <h2 class="text-xl font-semibold">ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">Âè≥Áúº</h3>
                            <div class="grid grid-cols-5 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">SPH</label>
                                    <div class="number-input-container" data-field="corrRightSph">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-20" max="20" id="corrRightSph" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="SPH" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">CYL</label>
                                    <div class="number-input-container" data-field="corrRightCyl">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-6" max="0" id="corrRightCyl" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="CYL" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">AXIS</label>
                                    <div class="flex items-center space-x-1">
                                        <button type="button" onclick="adjustAxis('corrRightAxis', -5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" min="0" max="180" step="5" id="corrRightAxis" class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="AXIS" />
                                        <button type="button" onclick="adjustAxis('corrRightAxis', 5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">ADD</label>
                                    <div class="number-input-container" data-field="corrRightAdd">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="0" max="3" id="corrRightAdd" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="ADD" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">Ë¶ñÂäõ</label>
                                    <select id="corrRightVision" class="w-full px-2 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="">ÈÅ∏Êäû</option>
                                        <option value="0.1">0.1</option>
                                        <option value="0.2">0.2</option>
                                        <option value="0.3">0.3</option>
                                        <option value="0.4">0.4</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.6">0.6</option>
                                        <option value="0.7">0.7</option>
                                        <option value="0.8">0.8</option>
                                        <option value="0.9">0.9</option>
                                        <option value="1.0">1.0</option>
                                        <option value="1.2">1.2</option>
                                        <option value="1.5">1.5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">Â∑¶Áúº</h3>
                            <div class="grid grid-cols-5 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">SPH</label>
                                    <div class="number-input-container" data-field="corrLeftSph">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-20" max="20" id="corrLeftSph" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="SPH" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">CYL</label>
                                    <div class="number-input-container" data-field="corrLeftCyl">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="-6" max="0" id="corrLeftCyl" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="CYL" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">AXIS</label>
                                    <div class="flex items-center space-x-1">
                                        <button type="button" onclick="adjustAxis('corrLeftAxis', -5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" min="0" max="180" step="5" id="corrLeftAxis" class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="AXIS" />
                                        <button type="button" onclick="adjustAxis('corrLeftAxis', 5)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">ADD</label>
                                    <div class="number-input-container" data-field="corrLeftAdd">
                                        <button type="button" class="minus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">-</button>
                                        <input type="number" step="0.25" min="0" max="3" id="corrLeftAdd" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-xs text-center focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="ADD" />
                                        <button type="button" class="plus-btn long-press-button w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">Ë¶ñÂäõ</label>
                                    <select id="corrLeftVision" class="w-full px-2 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="">ÈÅ∏Êäû</option>
                                        <option value="0.1">0.1</option>
                                        <option value="0.2">0.2</option>
                                        <option value="0.3">0.3</option>
                                        <option value="0.4">0.4</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.6">0.6</option>
                                        <option value="0.7">0.7</option>
                                        <option value="0.8">0.8</option>
                                        <option value="0.9">0.9</option>
                                        <option value="1.0">1.0</option>
                                        <option value="1.2">1.2</option>
                                        <option value="1.5">1.5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Âπ¥ÈΩ¢Âà•Êé®Â•®ADDË°®Á§∫ -->
                <div id="ageAddHint" class="prescription-card rounded-3xl shadow-xl p-4 border border-yellow-100 hidden">
                    <div class="flex items-center mb-2">
                        <div class="p-2 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-lg mr-3">
                            <div class="w-4 h-4 text-white flex items-center justify-center text-sm">üí°</div>
                        </div>
                        <h3 class="text-lg font-semibold">Âπ¥ÈΩ¢Âà•Êé®Â•®ADD</h3>
                    </div>
                    <div id="ageAddContent" class="text-sm text-gray-700">
                        <!-- Âπ¥ÈΩ¢Âà•Êé®Â•®ADDÂÜÖÂÆπ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>

                <!-- Âá¶ÊñπË®àÁÆó„Éú„Çø„É≥ -->
                <div class="flex space-x-3">
                    <button onclick="calculatePrescription()" class="flex-1 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all flex items-center justify-center">
                        <span class="mr-2">‚ú®</span>
                        È´òÁ≤æÂ∫¶Âá¶ÊñπË®àÁÆóÔºàADDÂØæÂøúÔºâ
                    </button>
                    <button onclick="savePrescription()" class="px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all flex items-center justify-center">
                        <span class="mr-2">üíæ</span>
                        ‰øùÂ≠ò
                    </button>
                </div>
            </div>

            <!-- Âè≥„Ç´„É©„É† - ÁµêÊûúË°®Á§∫ -->
            <div class="space-y-6" id="resultsColumn">
                <div id="noResults" class="prescription-card rounded-3xl shadow-xl p-6 border border-gray-100 text-center text-gray-500">
                    <div class="mb-4">
                        <div class="w-16 h-16 mx-auto bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center">
                            <span class="text-2xl text-white">üìä</span>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">Âä†ÂÖ•Â∫¶Êï∞ÂØæÂøúÈ´òÊ©üËÉΩÂá¶ÊñπË®àÁÆó„Ç∑„Çπ„ÉÜ„É†</h3>
                    <p class="text-sm mb-4">ÂÆüË∑µÁöÑ„Å™ÁúºÈè°Âá¶ÊñπÊ≥ïÂâá„Å´Âü∫„Å•„ÅÑ„ÅüË®àÁÆóÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                    <div class="text-xs text-gray-400">
                        <div>‚úì ‰π±Ë¶ñËª∏ÊñπÂêëÂà•Âá¶ÊñπÊ≥ïÂâáÂØæÂøú</div>
                        <div>‚úì Âπ¥ÈΩ¢Âà•ÊÖ£„ÇåÂà∂ÈôêÂØæÂøú</div>
                        <div>‚úì ‰∏çÂêåË¶ñ„Éª40‰ª£‰ª•ÈôçÁâπÂà•Âá¶ÁêÜÂØæÂøú</div>
                        <div>‚úì KB„Åã„Çâ„ÅÆÂ§âÂåñÈáèË°®Á§∫</div>
                        <div>‚úì Âá¶ÊñπÂ±•Ê≠¥‰øùÂ≠òÊ©üËÉΩ</div>
                        <div>‚úì „É¨„ÉïÂÄ§„Å®„ÅÆÊØîËºÉÂàÜÊûê</div>
                        <div>‚úì <strong>Âä†ÂÖ•Â∫¶Êï∞ÔºàADDÔºâÂØæÂøú</strong></div>
                        <div>‚úì <strong>Âπ¥ÈΩ¢Âà•Êé®Â•®ADDË®àÁÆó</strong></div>
                        <div>‚úì <strong>ÈÅ†Ëøë„Éª‰∏≠Ëøë„ÉªËøë„ÄÖ‰∏°Áî®„É¨„É≥„Ç∫Êé®Â•®</strong></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let chiefComplaints = [];
        let complaintsPriority = {};
        let maxComplaints = 3;
        let longPressInterval = null;
        let longPressTimeout = null;
        let isLongPressing = false;
        let prescriptionHistory = JSON.parse(localStorage.getItem('prescriptionHistory')) || [];

        // Âπ¥ÈΩ¢Âà•Êé®Â•®ADDÔºà‰øÆÊ≠£ÁâàÔºâ
        function getRecommendedAddPower(age) {
            if (age < 40) return 0;
            if (age < 46) return 0.50;  // 40-45Ê≠≥: +0.50D
            if (age < 51) return 1.00;  // 46-50Ê≠≥: +1.00D
            if (age < 56) return 1.25;  // 51-55Ê≠≥: +1.25D
            if (age < 61) return 1.50;  // 56-60Ê≠≥: +1.50D
            if (age < 66) return 1.75;  // 61-65Ê≠≥: +1.75D
            return 2.00;                // 66Ê≠≥‰ª•‰∏ä: +2.00D
        }

        // Âπ¥ÈΩ¢Â§âÊõ¥ÊôÇ„ÅÆADDÊé®Â•®Ë°®Á§∫
        function updateAgeBasedAddPower() {
            const age = parseInt(document.getElementById('age').value);
            const ageAddHint = document.getElementById('ageAddHint');
            const ageAddContent = document.getElementById('ageAddContent');
            
            if (age && age >= 40) {
                const recommendedAdd = getRecommendedAddPower(age);
                ageAddHint.classList.remove('hidden');
                ageAddContent.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-xl">
                        <div class="font-semibold text-yellow-800 mb-1">${age}Ê≠≥„ÅÆÊé®Â•®ADD: +${recommendedAdd.toFixed(2)}D</div>
                        <div class="text-yellow-700 text-xs">
                            „Åì„ÅÆÂÄ§„ÇíÂèÇËÄÉ„Å´ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅÆADDÊ¨Ñ„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                            ${age >= 66 ? 'ÊúÄÂ§ßÂÄ§„Å´ÈÅî„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ' : 'Âπ¥ÈΩ¢„Å´Âøú„Åò„Å¶„Åï„Çâ„Å´ÈÄ≤Ë°å„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ'}
                        </div>
                    </div>
                `;
                
                // Ëá™Âãï„ÅßADDÂÄ§„ÇíË®≠ÂÆöÔºàÂÆåÂÖ®ÁüØÊ≠£ÂÄ§Ôºâ
                document.getElementById('corrRightAdd').value = recommendedAdd.toFixed(2);
                document.getElementById('corrLeftAdd').value = recommendedAdd.toFixed(2);
            } else {
                ageAddHint.classList.add('hidden');
                // 40Ê≠≥Êú™Ê∫Ä„ÅÆÂ†¥Âêà„ÅØADDÂÄ§„Çí„ÇØ„É™„Ç¢
                document.getElementById('corrRightAdd').value = '';
                document.getElementById('corrLeftAdd').value = '';
            }
        }

        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:', message, 'at', source, lineno, colno);
            return false;
        };

        // Èï∑Êäº„ÅóÊ©üËÉΩ„ÅÆÂÆüË£ÖÔºà„Ç®„É©„ÉºÂØæÁ≠ñÁâàÔºâ
        function setupLongPressHandlers() {
            try {
                document.querySelectorAll('.number-input-container').forEach(container => {
                    const field = container.dataset.field;
                    if (!field) return;
                    
                    const input = document.getElementById(field);
                    const minusBtn = container.querySelector('.minus-btn');
                    const plusBtn = container.querySelector('.plus-btn');

                    if (!input || !minusBtn || !plusBtn) return;

                    function handleLongPress(direction) {
                        try {
                            isLongPressing = true;
                            const step = input.step ? parseFloat(input.step) : 0.25;
                            const min = input.min ? parseFloat(input.min) : -20;
                            const max = input.max ? parseFloat(input.max) : 20;
                            let currentValue = parseFloat(input.value) || 0;

                            function updateValue() {
                                if (direction === 'increase') {
                                    currentValue = Math.min(currentValue + step, max);
                                } else {
                                    currentValue = Math.max(currentValue - step, min);
                                }
                                input.value = currentValue.toFixed(2);
                                input.dispatchEvent(new Event('input'));
                            }

                            updateValue(); // Âç≥Â∫ß„Å´1ÂõûÂÆüË°å

                            longPressTimeout = setTimeout(() => {
                                if (isLongPressing) {
                                    longPressInterval = setInterval(updateValue, 100);
                                }
                            }, 500);
                        } catch (error) {
                            console.error('Èï∑Êäº„ÅóÂá¶ÁêÜ„Ç®„É©„Éº:', error);
                        }
                    }

                    function stopLongPress() {
                        isLongPressing = false;
                        if (longPressTimeout) {
                            clearTimeout(longPressTimeout);
                            longPressTimeout = null;
                        }
                        if (longPressInterval) {
                            clearInterval(longPressInterval);
                            longPressInterval = null;
                        }
                    }

                    // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà
                    minusBtn.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        handleLongPress('decrease');
                    });
                    plusBtn.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        handleLongPress('increase');
                    });
                    document.addEventListener('mouseup', stopLongPress);

                    // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
                    minusBtn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        handleLongPress('decrease');
                    });
                    plusBtn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        handleLongPress('increase');
                    });
                    document.addEventListener('touchend', stopLongPress);
                });
            } catch (error) {
                console.error('Èï∑Êäº„ÅóÊ©üËÉΩÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                // Èï∑Êäº„ÅóÊ©üËÉΩ„ÅåÂ§±Êïó„Åó„Å¶„ÇÇ„Ç¢„Éó„É™„ÅØÂãï‰Ωú„Åô„Çã„Çà„ÅÜ„Å´
            }
        }

        // ‰∏ªË®¥„ÅÆÂá¶ÁêÜ
        function handleComplaintChange(id) {
            try {
                const checkbox = document.getElementById('complaint' + id);
                const prioritySpan = document.getElementById('priority' + id);
                
                if (!checkbox || !prioritySpan) {
                    console.error('Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', id);
                    return;
                }
                
                if (checkbox.checked) {
                    if (chiefComplaints.length >= maxComplaints) {
                        checkbox.checked = false;
                        return;
                    }
                    chiefComplaints.push(id);
                    const priority = ['A', 'B', 'C'][chiefComplaints.length - 1];
                    complaintsPriority[id] = priority;
                    prioritySpan.textContent = priority;
                    
                    let bgColor = '';
                    if (priority === 'A') bgColor = 'bg-red-500';
                    else if (priority === 'B') bgColor = 'bg-yellow-500';
                    else bgColor = 'bg-green-500';
                    
                    prioritySpan.className = 'w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center text-white ' + bgColor;
                    prioritySpan.style.display = 'flex';
                } else {
                    const index = chiefComplaints.indexOf(id);
                    if (index > -1) {
                        chiefComplaints.splice(index, 1);
                        delete complaintsPriority[id];
                        prioritySpan.style.display = 'none';
                        
                        // ÊÆã„Çä„ÅÆ‰∏ªË®¥„ÅÆÂÑ™ÂÖàÂ∫¶„ÇíÂÜçË™øÊï¥
                        const priorities = ['A', 'B', 'C'];
                        chiefComplaints.forEach((complaintId, idx) => {
                            complaintsPriority[complaintId] = priorities[idx];
                            const span = document.getElementById('priority' + complaintId);
                            if (span) {
                                span.textContent = priorities[idx];
                                let bgColor = '';
                                if (priorities[idx] === 'A') bgColor = 'bg-red-500';
                                else if (priorities[idx] === 'B') bgColor = 'bg-yellow-500';
                                else bgColor = 'bg-green-500';
                                span.className = 'w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center text-white ' + bgColor;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('‰∏ªË®¥Âá¶ÁêÜ„Ç®„É©„Éº:', error);
            }
        }

        // Ëª∏Â∫¶Ë™øÊï¥
        function adjustAxis(elementId, increment) {
            try {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.error('Ëª∏Â∫¶Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', elementId);
                    return;
                }
                
                const current = parseInt(element.value) || 0;
                let newAxis = current + increment;
                
                if (newAxis < 0) {
                    newAxis = 175;
                } else if (newAxis > 180) {
                    newAxis = 0;
                }
                
                element.value = newAxis;
            } catch (error) {
                console.error('Ëª∏Â∫¶Ë™øÊï¥„Ç®„É©„Éº:', error);
            }
        }

        // Âá¶ÊñπË®àÁÆóÈñ¢Êï∞Áæ§ÔºàÂÖÉ„ÅÆ„Ç≥„Éº„Éâ„Åã„ÇâÊã°ÂºµÔºâ
        function getAdditionPower(age) {
            return getRecommendedAddPower(age);
        }

        function getAdjustmentPower(age) {
            if (age < 20) return 10;
            if (age < 25) return 8;
            if (age < 30) return 6;
            if (age < 35) return 5;
            if (age < 40) return 4;
            if (age < 45) return 3;
            if (age < 50) return 2.5;
            if (age < 55) return 2;
            if (age < 60) return 1.5;
            return 0.5;
        }

        function getAdaptationLimit(age) {
            if (age <= 20) return 1.50;
            if (age <= 30) return 1.25;
            if (age <= 40) return 1.00;
            if (age <= 50) return 0.75;
            if (age <= 60) return 0.75;
            return 1.00;
        }

        function getAstigmatismType(axis) {
            if (axis >= 0 && axis <= 30) return 'direct';
            if (axis >= 150 && axis <= 180) return 'direct';
            if (axis >= 60 && axis <= 120) return 'inverse';
            return 'oblique';
        }

        function getAstigmatismFactor(axis) {
            const type = getAstigmatismType(axis);
            switch(type) {
                case 'direct':   return 1/3;
                case 'inverse':  return 1/2;
                case 'oblique':  return 1/3;
                default:         return 1/3;
            }
        }

        // „É¨„ÉïÂÄ§„Å®„ÅÆÊØîËºÉÂàÜÊûê
        function getRefractiveHint() {
            const rightRefSph = parseFloat(getElementValue('refRightSph')) || 0;
            const leftRefSph = parseFloat(getElementValue('refLeftSph')) || 0;
            const rightCorrSph = parseFloat(getElementValue('corrRightSph')) || 0;
            const leftCorrSph = parseFloat(getElementValue('corrLeftSph')) || 0;
            
            const rightDiff = Math.abs(rightRefSph - rightCorrSph);
            const leftDiff = Math.abs(leftRefSph - leftCorrSph);
            
            if (rightDiff > 1.0 || leftDiff > 1.0) {
                return {
                    type: "warning",
                    message: "„É¨„ÉïÂÄ§„Å®ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„Å´Â§ß„Åç„Å™Â∑Æ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊ∏¨ÂÆö„ÅÆÂÜçÁ¢∫Ë™ç„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„ÄÇ"
                };
            } else if (rightDiff > 0.5 || leftDiff > 0.5) {
                return {
                    type: "info",
                    message: "„É¨„ÉïÂÄ§„Å®ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„Å´Â∑Æ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇË™øÁØÄÁ∑äÂºµ„ÅÆÂèØËÉΩÊÄß„ÇíËÄÉÊÖÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                };
            } else {
                return {
                    type: "success",
                    message: "„É¨„ÉïÂÄ§„Å®ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅåËøë‰ºº„Åó„Å¶„Åä„Çä„ÄÅËâØÂ•Ω„Å™Ê∏¨ÂÆöÁµêÊûú„Åß„Åô„ÄÇ"
                };
            }
        }

        // KB„Åã„Çâ„ÅÆÂ§âÂåñÈáèË®àÁÆóÔºàADDÂØæÂøúÔºâ
        function calculateChanges(prescription) {
            const hasKB = document.getElementById('hasKB').checked;
            if (!hasKB) return null;

            const rightChange = {
                sph: prescription.right.sph - (parseFloat(getElementValue('kbRightSph')) || 0),
                cyl: prescription.right.cyl - (parseFloat(getElementValue('kbRightCyl')) || 0),
                axis: prescription.right.axis - (parseInt(getElementValue('kbRightAxis')) || 0),
                add: prescription.right.add - (parseFloat(getElementValue('kbRightAdd')) || 0)
            };

            const leftChange = {
                sph: prescription.left.sph - (parseFloat(getElementValue('kbLeftSph')) || 0),
                cyl: prescription.left.cyl - (parseFloat(getElementValue('kbLeftCyl')) || 0),
                axis: prescription.left.axis - (parseInt(getElementValue('kbLeftAxis')) || 0),
                add: prescription.left.add - (parseFloat(getElementValue('kbLeftAdd')) || 0)
            };

            return { right: rightChange, left: leftChange };
        }

        // ÊòéË¶ñÂüüË®àÁÆó
        function calculateNearPoint(sph, adjustmentPower) {
            const refractivePower = parseFloat(sph) || 0;
            const adjustment = parseFloat(adjustmentPower) || 0;
            
            const nearPointPower = refractivePower - adjustment;
            
            if (nearPointPower === 0) return "‚àû";
            
            const nearPointM = 1 / nearPointPower;
            const nearPointCm = Math.abs(nearPointM * 100);
            
            if (nearPointCm > 1000) return "‚àû";
            
            return nearPointCm.toFixed(0) + "cm";
        }

        // ÂÖÉ„ÅÆÂá¶ÊñπË®àÁÆóÊ©üËÉΩ„Çí„Éô„Éº„Çπ„Å´Êã°ÂºµÔºàADDÂØæÂøúÔºâ
        function adjustAstigmatismPrescription(targetCyl, targetAxis, hasKB, kbCyl, kbAxis, usageYears, age) {
            const targetCylValue = parseFloat(targetCyl) || 0;
            const targetAxisValue = parseInt(targetAxis) || 0;
            const kbCylValue = parseFloat(kbCyl) || 0;
            const kbAxisValue = parseInt(kbAxis) || 0;
            
            let adjustedCyl = Math.round(targetCylValue * 4) / 4;
            adjustedCyl = Math.max(adjustedCyl, -6.00);
            
            let adjustedAxis = Math.round(targetAxisValue / 5) * 5;
            if (adjustedAxis === 180) adjustedAxis = 0;
            
            if (!hasKB) {
                // ÂàùÂõûÂá¶ÊñπÔºöËª∏ÊñπÂêëÂà•Âá¶ÊñπÊ≥ïÂâá„ÇíÈÅ©Áî®Ôºà„Çà„Çä‰øùÂÆàÁöÑ„Å´Ôºâ
                const factor = getAstigmatismFactor(targetAxisValue);
                adjustedCyl = targetCylValue * factor * 0.8; // „Çà„Çä‰øùÂÆàÁöÑ„Å´80%„Å´ÊäëÂà∂
                adjustedCyl = Math.round(adjustedCyl * 4) / 4;
                adjustedCyl = Math.max(adjustedCyl, -6.00);
                
                return { cyl: adjustedCyl, axis: adjustedAxis };
            }
            
            const cylDifference = Math.abs(targetCylValue - kbCylValue);
            
            let axisDifference = Math.abs(targetAxisValue - kbAxisValue);
            if (axisDifference > 90) {
                axisDifference = 180 - axisDifference;
            }
            
            // „Çà„Çä‰øùÂÆàÁöÑ„Å™ÈÅ©Âøú‰øÇÊï∞Ë®≠ÂÆö
            let adaptationFactor = 0.5; // „Éá„Éï„Ç©„É´„Éà„Çí50%„Å´‰∏ã„Åí„Çã
            if (usageYears >= 5) adaptationFactor = 0.3; // Èï∑Êúü‰ΩøÁî®„ÅØ30%
            else if (usageYears >= 3) adaptationFactor = 0.4; // 3Âπ¥‰ª•‰∏ä„ÅØ40%
            else if (usageYears >= 1) adaptationFactor = 0.5; // 1Âπ¥‰ª•‰∏ä„ÅØ50%
            
            // Âπ¥ÈΩ¢„Å´„Çà„ÇãËøΩÂä†Âà∂ÈôêÔºà„Çà„ÇäÂé≥Ê†º„Å´Ôºâ
            if (age >= 60) adaptationFactor *= 0.6; // 60Ê≠≥‰ª•‰∏ä„ÅØ„Åï„Çâ„Å´Âà∂Èôê
            else if (age >= 50) adaptationFactor *= 0.7; // 50Ê≠≥‰ª•‰∏ä„ÇÇÂà∂Èôê
            else if (age >= 40) adaptationFactor *= 0.8; // 40Ê≠≥‰ª•‰∏ä„ÇÇËªΩÂæÆ„Å™Âà∂Èôê
            
            // ‰π±Ë¶ñÂ∫¶Êï∞Â§âÂåñ„ÅÆÂà∂ÈôêÔºà„Çà„ÇäÂé≥Ê†º„Å´Ôºâ
            if (cylDifference <= 0.25) {
                // 0.25D‰ª•‰∏ã„ÅÆÂ§âÂåñ„ÅØË®±ÂèØ
                adjustedCyl = targetCylValue;
            } else if (cylDifference <= 0.5) {
                // 0.5D‰ª•‰∏ã„ÅØ80%ÈÅ©Áî®
                adjustedCyl = kbCylValue + (targetCylValue - kbCylValue) * adaptationFactor * 0.8;
            } else if (cylDifference <= 1.0) {
                // 1.0D‰ª•‰∏ã„ÅØ60%ÈÅ©Áî®
                adjustedCyl = kbCylValue + (targetCylValue - kbCylValue) * adaptationFactor * 0.6;
            } else {
                // 1.0D„ÇíË∂Ö„Åà„ÇãÂ§ß„Åç„Å™Â§âÂåñ„ÅØÊúÄÂ§ß40%„Åæ„Åß
                adjustedCyl = kbCylValue + (targetCylValue - kbCylValue) * adaptationFactor * 0.4;
            }
            
            // Áµ∂ÂØæÁöÑ„Å™Â§âÂåñÈáèÂà∂Èôê„ÇíËøΩÂä†
            const maxCylChange = age >= 50 ? 0.5 : 0.75; // 50Ê≠≥‰ª•‰∏ä„ÅØ0.5D„ÄÅÊú™Ê∫Ä„ÅØ0.75D„Åæ„Åß
            const actualChange = adjustedCyl - kbCylValue;
            if (Math.abs(actualChange) > maxCylChange) {
                adjustedCyl = kbCylValue + Math.sign(actualChange) * maxCylChange;
            }
            
            // Ëª∏Â∫¶Â§âÊõ¥„ÅÆÂà∂ÈôêÔºà„Çà„ÇäÂé≥Ê†º„Å´Ôºâ
            if (axisDifference <= 10) {
                // 10Â∫¶‰ª•ÂÜÖ„ÅÆÂ§âÂåñ„ÅØË®±ÂèØÔºà15Â∫¶„Åã„ÇâÁü≠Á∏ÆÔºâ
                adjustedAxis = targetAxisValue;
            } else {
                // 10Â∫¶„ÇíË∂Ö„Åà„ÇãÂ§âÂåñ„ÅØÂà∂ÈôêÔºàÊÆµÈöéÁöÑ„Å´5Â∫¶„Åæ„ÅßÔºâ
                let axisDiff = targetAxisValue - kbAxisValue;
                
                if (Math.abs(axisDiff) > 90) {
                    if (axisDiff > 0) {
                        axisDiff = axisDiff - 180;
                    } else {
                        axisDiff = axisDiff + 180;
                    }
                }
                
                // „Çà„Çä‰øùÂÆàÁöÑ„Å™Ëª∏Â∫¶Âà∂ÈôêÔºà10Â∫¶„Åæ„ÅßÔºâ
                if (axisDiff > 10) {
                    adjustedAxis = kbAxisValue + 10;
                } else if (axisDiff < -10) {
                    adjustedAxis = kbAxisValue - 10;
                } else {
                    adjustedAxis = targetAxisValue;
                }
            }
            
            // Êñú‰π±Ë¶ñ„ÅÆËª∏Â∫¶„ÅØÂ§âÊõ¥„Åó„Å™„ÅÑÔºàÁµ∂ÂØæ„É´„Éº„É´Ôºâ
            const kbType = getAstigmatismType(kbAxisValue);
            if (kbType === 'oblique' && usageYears >= 1) {
                adjustedAxis = kbAxisValue;
            }
            
            // ÊúÄÁµÇË™øÊï¥
            adjustedCyl = Math.round(adjustedCyl * 4) / 4;
            adjustedCyl = Math.max(adjustedCyl, -6.00);
            adjustedAxis = Math.round(adjustedAxis / 5) * 5;
            
            // Ëª∏Â∫¶„ÅÆÁØÑÂõ≤Ë™øÊï¥Ôºà0-179Â∫¶Ôºâ
            while (adjustedAxis < 0) adjustedAxis += 180;
            while (adjustedAxis >= 180) adjustedAxis -= 180;
            
            return { cyl: adjustedCyl, axis: adjustedAxis };
        }

        function adjustSpherePrescription(targetSph, hasKB, kbSph, usageYears, age, mainComplaint) {
            const targetSphValue = parseFloat(targetSph) || 0;
            const kbSphValue = parseFloat(kbSph) || 0;
            
            let adjustedSph = targetSphValue;
            const adaptationLimit = getAdaptationLimit(age);
            
            // ‰∏ªË®¥AÔºàÈÅ†ÊñπÈáçË¶ñÔºâ„ÅÆÁâπÂà•Âá¶ÁêÜ
            const isDistanceVisionPriority = mainComplaint === 1; // complaint1 = ÈÅ†ÊñπË¶ñÂäõ‰Ωé‰∏ã
            
            if (!hasKB) {
                // ÂàùÂõûÂá¶Êñπ„ÅÆË™øÊï¥
                if (isDistanceVisionPriority) {
                    // ‰∏ªË®¥AÔºàÈÅ†ÊñπÈáçË¶ñÔºâ: ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅÆ80%„ÅßÂá¶Êñπ
                    adjustedSph = targetSphValue * 0.8;
                } else if (targetSphValue > 0) {
                    // ÈÄöÂ∏∏„ÅÆÈÅ†Ë¶ñÂá¶Êñπ: ÂàùÂõû„ÅØ+0.50D‰ª•‰∏ã
                    if (targetSphValue > 0.50) {
                        adjustedSph = 0.50;
                    } else {
                        adjustedSph = targetSphValue;
                    }
                } else {
                    // ÈÄöÂ∏∏„ÅÆËøëË¶ñÂá¶Êñπ: 75-80%„ÅßÂá¶Êñπ
                    adjustedSph = targetSphValue * 0.75;
                }
            } else {
                // KBÊúâ„Çä„ÅÆÂ†¥Âêà
                const sphDifference = targetSphValue - kbSphValue;
                let changeFactor;
                
                // ‰∏ªË®¥AÔºàÈÅ†ÊñπÈáçË¶ñÔºâ„ÅÆÁâπÂà•Âá¶ÁêÜ
                if (isDistanceVisionPriority) {
                    // KB„Åã„Çâ„ÅØ4ÊÆµÈöé‰ª•ÂÜÖÔºà1.00D‰ª•ÂÜÖÔºâ„Å´Âà∂Èôê
                    const maxChangeForDistance = 1.00; // 4ÊÆµÈöé = 1.00D
                    const limitedDifference = Math.sign(sphDifference) * Math.min(Math.abs(sphDifference), maxChangeForDistance);
                    
                    // ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅÆ80%„ÇíÁõÆÊ®ô„Å®„Åô„Çã
                    const targetAdjusted = targetSphValue * 0.8;
                    const targetDifference = targetAdjusted - kbSphValue;
                    
                    // 4ÊÆµÈöéÂà∂Èôê„Å®80%Âá¶Êñπ„ÅÆ„ÅÜ„Å°„ÄÅ„Çà„Çä‰øùÂÆàÁöÑ„Å™Êñπ„ÇíÊé°Áî®
                    if (Math.abs(targetDifference) <= maxChangeForDistance) {
                        adjustedSph = targetAdjusted;
                    } else {
                        adjustedSph = kbSphValue + limitedDifference;
                    }
                } else {
                    // ÈÄöÂ∏∏„ÅÆÂá¶ÊñπÔºà‰∏ªË®¥A‰ª•Â§ñÔºâ
                    // ‰ΩøÁî®Âπ¥Êï∞„Å´„Çà„ÇãË™øÊï¥
                    if (usageYears >= 5) changeFactor = 0.4;
                    else if (usageYears >= 3) changeFactor = 0.6;
                    else if (usageYears >= 1) changeFactor = 0.75;
                    else changeFactor = 0.85;
                    
                    // Âπ¥ÈΩ¢„Å´„Çà„ÇãËøΩÂä†Âà∂Èôê
                    if (age >= 60) changeFactor *= 0.8;
                    else if (age >= 50) changeFactor *= 0.9;
                    
                    // Âπ¥ÈΩ¢Âà•ÊÖ£„ÇåÂà∂Èôê„ÅÆÈÅ©Áî®
                    const maxChange = Math.min(Math.abs(sphDifference), adaptationLimit);
                    const limitedChange = sphDifference > 0 ? maxChange : -maxChange;
                    
                    // Â∫¶Êï∞Â§âÂåñÈáè„ÅÆÂà∂Èôê
                    if (Math.abs(sphDifference) <= 0.5) {
                        adjustedSph = targetSphValue;
                    } else {
                        adjustedSph = kbSphValue + limitedChange * changeFactor;
                    }
                }
            }
            
            // ÊúÄÁµÇË™øÊï¥
            adjustedSph = Math.round(adjustedSph * 4) / 4;
            adjustedSph = Math.max(-20.00, Math.min(20.00, adjustedSph));
            
            return adjustedSph;
        }

        // ADDÂá¶ÊñπË™øÊï¥ÔºàÊñ∞Ê©üËÉΩÔºâ
        function adjustAddPrescription(targetAdd, hasKB, kbAdd, usageYears, age) {
            const targetAddValue = parseFloat(targetAdd) || 0;
            const kbAddValue = parseFloat(kbAdd) || 0;
            
            // 40Ê≠≥Êú™Ê∫Ä„ÅØADD‰∏çË¶Å
            if (age < 40) return 0;
            
            let adjustedAdd = targetAddValue;
            
            if (!hasKB) {
                // ÂàùÂõûÂá¶Êñπ: Êé®Â•®ÂÄ§„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
                adjustedAdd = getRecommendedAddPower(age);
            } else {
                // KBÊúâ„Çä„ÅÆÂ†¥Âêà: ÊÆµÈöéÁöÑÂ¢óÂä†
                const addDifference = targetAddValue - kbAddValue;
                let changeFactor = 1.0; // ADD„ÅØÂü∫Êú¨ÁöÑ„Å´ÂÆåÂÖ®ÁüØÊ≠£„Å´Ëøë„Å•„Åë„Çã
                
                // ‰ΩøÁî®Âπ¥Êï∞„Å´„Çà„ÇãË™øÊï¥ÔºàADD„ÅØÊÖéÈáç„Å´Ôºâ
                if (usageYears >= 5) changeFactor = 0.8;
                else if (usageYears >= 3) changeFactor = 0.9;
                
                // ADDÂ§âÂåñÈáè„ÅÆÂà∂ÈôêÔºàÊúÄÂ§ß0.50D„Åæ„ÅßÔºâ
                if (Math.abs(addDifference) <= 0.25) {
                    adjustedAdd = targetAddValue;
                } else if (Math.abs(addDifference) <= 0.50) {
                    adjustedAdd = kbAddValue + (addDifference * changeFactor);
                } else {
                    // 0.50D„ÇíË∂Ö„Åà„ÇãÂ§âÂåñ„ÅØÊÆµÈöéÁöÑ„Å´
                    adjustedAdd = kbAddValue + Math.sign(addDifference) * 0.50;
                }
            }
            
            // ÊúÄÁµÇË™øÊï¥
            adjustedAdd = Math.round(adjustedAdd * 4) / 4;
            adjustedAdd = Math.max(0, Math.min(3.00, adjustedAdd));
            
            return adjustedAdd;
        }

        function checkAnisometropia(rightVision, leftVision, hasKB) {
            const rightVisionValue = parseFloat(rightVision) || 1.0;
            const leftVisionValue = parseFloat(leftVision) || 1.0;
            const visionDifference = Math.abs(rightVisionValue - leftVisionValue);
            
            if (hasKB && visionDifference >= 0.3) {
                return true;
            }
            
            return false;
        }

        function adjustBinocularBalance(rightSph, leftSph, rightCyl, leftCyl, age) {
            const rightSE = rightSph + (rightCyl / 2);
            const leftSE = leftSph + (leftCyl / 2);
            const difference = Math.abs(rightSE - leftSE);
            
            if (difference >= 2.0 && age < 50) {
                const avgSE = (rightSE + leftSE) / 2;
                const adjustment = difference * 0.3;
                
                if (rightSE > leftSE) {
                    rightSph -= adjustment;
                    leftSph += adjustment;
                } else {
                    rightSph += adjustment;
                    leftSph -= adjustment;
                }
            }
            
            return {
                rightSph: Math.round(rightSph * 4) / 4,
                leftSph: Math.round(leftSph * 4) / 4
            };
        }

        function apply40PlusSpecialHandling(age, rightPrescription, leftPrescription, addPower, hasKB, kbUsageYears) {
            if (age < 40) return { rightPrescription, leftPrescription };
            
            if (hasKB && kbUsageYears >= 2) {
                const expectedAdd = getAdditionPower(age);
                
                const maxSphAdjustment = 0.75;
                
                rightPrescription.sph = Math.max(
                    rightPrescription.sph - maxSphAdjustment,
                    rightPrescription.sph
                );
                leftPrescription.sph = Math.max(
                    leftPrescription.sph - maxSphAdjustment,
                    leftPrescription.sph
                );
            }
            
            return { rightPrescription, leftPrescription };
        }

        function getElementValue(id) {
            const element = document.getElementById(id);
            return element ? element.value : '';
        }

        // „É°„Ç§„É≥Ë®àÁÆóÈñ¢Êï∞ÔºàADDÂØæÂøúÔºâ
        function calculatePrescription() {
            try {
                console.log('Âá¶ÊñπË®àÁÆóÈñãÂßã');
                
                const age = parseInt(getElementValue('age'));
                if (!age || age < 10 || age > 100) {
                    alert('Âπ¥ÈΩ¢„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà10-100Ê≠≥Ôºâ');
                    return;
                }

                console.log('Âπ¥ÈΩ¢:', age);

                const addPower = getAdditionPower(age);
                const adjustmentPower = getAdjustmentPower(age);
                
                // ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅÆÂèñÂæóÔºà„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË®≠ÂÆöÔºâ
                const rightSph = parseFloat(getElementValue('corrRightSph')) || 0;
                const rightCyl = parseFloat(getElementValue('corrRightCyl')) || 0;
                const rightAxis = parseInt(getElementValue('corrRightAxis')) || 0;
                const rightAdd = parseFloat(getElementValue('corrRightAdd')) || addPower; // ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅÆADD
                
                const leftSph = parseFloat(getElementValue('corrLeftSph')) || 0;
                const leftCyl = parseFloat(getElementValue('corrLeftCyl')) || 0;
                const leftAxis = parseInt(getElementValue('corrLeftAxis')) || 0;
                const leftAdd = parseFloat(getElementValue('corrLeftAdd')) || addPower; // ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅÆADD

                console.log('ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§ÂèñÂæóÂÆå‰∫Ü');

                const hasKB = document.getElementById('hasKB') ? document.getElementById('hasKB').checked : false;
                const kbUsageYears = parseInt(getElementValue('kbUsageYears')) || 0;
                
                const mainComplaint = chiefComplaints.length > 0 ? chiefComplaints[0] : 0;

                console.log('Âü∫Êú¨ÊÉÖÂ†±ÂèñÂæóÂÆå‰∫Ü');

                const isAnisometropia = checkAnisometropia(
                    getElementValue('kbRightVision'), 
                    getElementValue('kbLeftVision'), 
                    hasKB
                );

                let adjustedRightSph = adjustSpherePrescription(
                    rightSph, hasKB, getElementValue('kbRightSph'), 
                    kbUsageYears, age, mainComplaint
                );
                let adjustedLeftSph = adjustSpherePrescription(
                    leftSph, hasKB, getElementValue('kbLeftSph'), 
                    kbUsageYears, age, mainComplaint
                );

                console.log('ÁêÉÈù¢Â∫¶Êï∞Ë™øÊï¥ÂÆå‰∫Ü');

                if (isAnisometropia) {
                    adjustedRightSph = parseFloat(getElementValue('kbRightSph')) || rightSph;
                    adjustedLeftSph = parseFloat(getElementValue('kbLeftSph')) || leftSph;
                }

                const rightAstigmatism = adjustAstigmatismPrescription(
                    rightCyl, rightAxis, hasKB, 
                    getElementValue('kbRightCyl'), getElementValue('kbRightAxis'), 
                    kbUsageYears, age
                );
                
                const leftAstigmatism = adjustAstigmatismPrescription(
                    leftCyl, leftAxis, hasKB, 
                    getElementValue('kbLeftCyl'), getElementValue('kbLeftAxis'), 
                    kbUsageYears, age
                );

                console.log('‰π±Ë¶ñË™øÊï¥ÂÆå‰∫Ü');

                // ADDË™øÊï¥ÔºàÊñ∞Ê©üËÉΩÔºâ
                const adjustedRightAdd = adjustAddPrescription(
                    rightAdd, hasKB, getElementValue('kbRightAdd'), 
                    kbUsageYears, age
                );
                const adjustedLeftAdd = adjustAddPrescription(
                    leftAdd, hasKB, getElementValue('kbLeftAdd'), 
                    kbUsageYears, age
                );

                console.log('ADDË™øÊï¥ÂÆå‰∫Ü');

                let balancedSphere = { rightSph: adjustedRightSph, leftSph: adjustedLeftSph };
                if (!isAnisometropia) {
                    balancedSphere = adjustBinocularBalance(
                        adjustedRightSph, adjustedLeftSph, 
                        rightAstigmatism.cyl, leftAstigmatism.cyl, age
                    );
                }

                let rightPrescription = {
                    sph: balancedSphere.rightSph,
                    cyl: rightAstigmatism.cyl,
                    axis: rightAstigmatism.axis,
                    add: adjustedRightAdd
                };
                
                let leftPrescription = {
                    sph: balancedSphere.leftSph,
                    cyl: leftAstigmatism.cyl,
                    axis: leftAstigmatism.axis,
                    add: adjustedLeftAdd
                };

                console.log('Âá¶ÊñπÂÄ§Ë®àÁÆóÂÆå‰∫Ü');

                const specialHandling = apply40PlusSpecialHandling(
                    age, rightPrescription, leftPrescription, addPower, hasKB, kbUsageYears
                );
                rightPrescription = specialHandling.rightPrescription;
                leftPrescription = specialHandling.leftPrescription;

                if (rightPrescription.cyl === 0) rightPrescription.axis = 0;
                if (leftPrescription.cyl === 0) leftPrescription.axis = 0;

                const prescription = {
                    right: rightPrescription,
                    left: leftPrescription,
                    addPower: Math.max(adjustedRightAdd, adjustedLeftAdd), // Â∑¶Âè≥„ÅÆÂ§ß„Åç„ÅÑÊñπ
                    timestamp: new Date().toISOString(),
                    patient: getElementValue('patientName') || 'ÂêçÂâç„Å™„Åó',
                    age: age,
                    chiefComplaints: chiefComplaints,
                    hasKB: hasKB,
                    isAnisometropia: isAnisometropia
                };

                console.log('Âá¶Êñπ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰ΩúÊàêÂÆå‰∫Ü');

                // KB„Åã„Çâ„ÅÆÂ§âÂåñÈáèË®àÁÆóÔºàADDÂØæÂøúÔºâ
                const changes = calculateChanges(prescription);
                if (changes) {
                    prescription.changes = changes;
                }

                // „É¨„ÉïÂÄ§ÊØîËºÉ
                prescription.refHint = getRefractiveHint();

                // ÊòéË¶ñÂüüË®àÁÆó
                const rightSphericalEquivalent = rightPrescription.sph + (rightPrescription.cyl / 2);
                const leftSphericalEquivalent = leftPrescription.sph + (leftPrescription.cyl / 2);
                const averageSphericalEquivalent = (rightSphericalEquivalent + leftSphericalEquivalent) / 2;
                
                prescription.nearPoint = calculateNearPoint(averageSphericalEquivalent, adjustmentPower);

                console.log('ÊúÄÁµÇÂá¶ÊñπË®àÁÆóÂÆå‰∫Ü');

                displayResults(prescription);
                
                console.log('Âá¶ÊñπË®àÁÆóÂÆå‰∫Ü');
            } catch (error) {
                console.error('Âá¶ÊñπË®àÁÆó„Ç®„É©„Éº:', error);
                alert('Ë®àÁÆó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message + '\n\n„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´„Åß„Åï„Çâ„Å´Ë©≥Á¥∞„Å™„Ç®„É©„ÉºÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ');
            }
        }

        // Âá¶Êñπ„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
        function savePrescription() {
            const prescription = window.currentPrescription;
            if (!prescription) {
                alert('‰øùÂ≠ò„Åô„ÇãÂá¶Êñπ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÂá¶ÊñπË®àÁÆó„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            prescriptionHistory.unshift(prescription);
            if (prescriptionHistory.length > 20) {
                prescriptionHistory = prescriptionHistory.slice(0, 20);
            }

            localStorage.setItem('prescriptionHistory', JSON.stringify(prescriptionHistory));
            alert('Âá¶Êñπ„Éá„Éº„Çø„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºàÊúÄÊñ∞20‰ª∂„Åæ„Åß‰øùÂ≠òÔºâ');
        }

        // Â±•Ê≠¥Ë°®Á§∫„ÅÆÂàá„ÇäÊõø„Åà
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            const content = document.getElementById('historyContent');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                displayHistory();
            } else {
                panel.classList.add('hidden');
            }
        }

        // Â±•Ê≠¥Ë°®Á§∫
        function displayHistory() {
            const content = document.getElementById('historyContent');
            
            if (prescriptionHistory.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-500 py-4">‰øùÂ≠ò„Åï„Çå„ÅüÂá¶Êñπ„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            let historyHTML = '';
            prescriptionHistory.forEach((item, index) => {
                const date = new Date(item.timestamp).toLocaleString('ja-JP');
                const addDisplay = item.addPower > 0 ? ` ADD +${item.addPower.toFixed(2)}` : '';
                historyHTML += `
                    <div class="bg-white/50 p-3 rounded-xl border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-semibold text-sm">${item.patient} (${item.age}Ê≠≥)</div>
                                <div class="text-xs text-gray-500">${date}</div>
                            </div>
                            <button onclick="loadPrescription(${index})" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Ë™≠Ëæº
                            </button>
                        </div>
                        <div class="text-xs text-gray-600 grid grid-cols-2 gap-2">
                            <div>Âè≥Áúº: SPH ${item.right.sph >= 0 ? '+' : ''}${item.right.sph.toFixed(2)} CYL ${item.right.cyl.toFixed(2)}${addDisplay}</div>
                            <div>Â∑¶Áúº: SPH ${item.left.sph >= 0 ? '+' : ''}${item.left.sph.toFixed(2)} CYL ${item.left.cyl.toFixed(2)}${addDisplay}</div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = historyHTML;
        }

        // Âá¶Êñπ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
        function loadPrescription(index) {
            const prescription = prescriptionHistory[index];
            if (!prescription) return;

            // Âü∫Êú¨ÊÉÖÂ†±„ÅÆÂæ©ÂÖÉ„ÅØÁúÅÁï•ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶ÂÆüË£ÖÔºâ
            alert(`Âá¶Êñπ„Éá„Éº„Çø„Äå${prescription.patient}„Äç„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü`);
            displayResults(prescription);
            toggleHistory();
        }

        // ÂÖ®„Éá„Éº„ÇøÂâäÈô§
        function clearAllData() {
            if (confirm('ÂÖ®„Å¶„ÅÆÂá¶ÊñπÂ±•Ê≠¥„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                prescriptionHistory = [];
                localStorage.removeItem('prescriptionHistory');
                alert('ÂÖ®„Å¶„ÅÆÂá¶ÊñπÂ±•Ê≠¥„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü');
                if (!document.getElementById('historyPanel').classList.contains('hidden')) {
                    displayHistory();
                }
            }
        }

        // Êã°Âºµ„Åï„Çå„ÅüÁµêÊûúË°®Á§∫Ê©üËÉΩÔºàADDÂØæÂøúÔºâ
        function displayResults(prescription) {
            window.currentPrescription = prescription;
            
            try {
                const resultsColumn = document.getElementById('resultsColumn');
                const noResults = document.getElementById('noResults');
                
                if (noResults) {
                    noResults.style.display = 'none';
                }
                
                let resultsHTML = `
                    <!-- Âá¶ÊñπÁµêÊûú -->
                    <div class="prescription-card rounded-3xl shadow-xl p-6 border border-purple-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="p-2 bg-gradient-to-r from-green-400 to-emerald-400 rounded-lg mr-3">
                                    <div class="w-5 h-5 text-white flex items-center justify-center">‚úÖ</div>
                                </div>
                                <h2 class="text-xl font-semibold">È´òÁ≤æÂ∫¶Âá¶ÊñπÁµêÊûúÔºàADDÂØæÂøúÔºâ</h2>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${new Date(prescription.timestamp).toLocaleString('ja-JP')}
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-4 rounded-2xl">
                                    <h3 class="font-semibold text-sm text-gray-700 mb-2">Âè≥Áúº (OD)</h3>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between">
                                            <span>SPH:</span>
                                            <span class="font-mono font-bold">${prescription.right.sph >= 0 ? '+' : ''}${prescription.right.sph.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>CYL:</span>
                                            <span class="font-mono font-bold">${prescription.right.cyl.toFixed(2)}</span>
                                        </div>
                                        ${prescription.right.cyl !== 0 ? `
                                        <div class="flex justify-between">
                                            <span>AXIS:</span>
                                            <span class="font-mono font-bold">${prescription.right.axis}¬∞</span>
                                        </div>` : ''}
                                        ${prescription.right.add > 0 ? `
                                        <div class="flex justify-between">
                                            <span>ADD:</span>
                                            <span class="font-mono font-bold text-orange-600">+${prescription.right.add.toFixed(2)}</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-pink-50 to-purple-50 p-4 rounded-2xl">
                                    <h3 class="font-semibold text-sm text-gray-700 mb-2">Â∑¶Áúº (OS)</h3>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between">
                                            <span>SPH:</span>
                                            <span class="font-mono font-bold">${prescription.left.sph >= 0 ? '+' : ''}${prescription.left.sph.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>CYL:</span>
                                            <span class="font-mono font-bold">${prescription.left.cyl.toFixed(2)}</span>
                                        </div>
                                        ${prescription.left.cyl !== 0 ? `
                                        <div class="flex justify-between">
                                            <span>AXIS:</span>
                                            <span class="font-mono font-bold">${prescription.left.axis}¬∞</span>
                                        </div>` : ''}
                                        ${prescription.left.add > 0 ? `
                                        <div class="flex justify-between">
                                            <span>ADD:</span>
                                            <span class="font-mono font-bold text-orange-600">+${prescription.left.add.toFixed(2)}</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                            </div>

                            ${prescription.addPower > 0 ? `
                            <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-4 rounded-2xl border border-orange-200">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Êé®Â•®Âä†ÂÖ•Â∫¶Êï∞ (ADD):</span>
                                    <span class="font-mono font-bold text-lg text-orange-600">+${prescription.addPower.toFixed(2)}</span>
                                </div>
                                <div class="text-xs text-orange-700 mt-1">
                                    ${prescription.age}Ê≠≥„Åß„ÅÆÊ®ôÊ∫ñÁöÑ„Å™Âä†ÂÖ•Â∫¶Êï∞„Åß„Åô
                                </div>
                            </div>` : ''}
                        </div>
                    </div>`;

                // „É¨„É≥„Ç∫Êé®Â•®Ê©üËÉΩÔºàADDÂØæÂøúÔºâ
                const lensRecommendations = generateLensRecommendations(prescription);
                resultsHTML += `
                <div class="prescription-card rounded-3xl shadow-xl p-6 border border-green-100">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-gradient-to-r from-green-400 to-emerald-400 rounded-lg mr-3">
                            <div class="w-5 h-5 text-white flex items-center justify-center">üëÅÔ∏è</div>
                        </div>
                        <h2 class="text-xl font-semibold">„É¨„É≥„Ç∫Êé®Â•®ÔºàADDÂØæÂøúÔºâ</h2>
                    </div>
                    
                    <div class="space-y-3">`;
                
                lensRecommendations.forEach((lens, index) => {
                    resultsHTML += `
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-2xl border border-green-200">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-semibold text-sm text-gray-700">${lens.type}</h4>
                                    <p class="text-xs text-gray-600">${lens.note}</p>
                                </div>
                                <div class="text-xs text-gray-500">${lens.distance}</div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white/60 p-3 rounded-xl">
                                    <h5 class="text-xs font-semibold text-gray-600 mb-2">Âè≥Áúº (OD)</h5>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>SPH:</span>
                                            <span class="font-mono font-bold">${lens.rightSph >= 0 ? '+' : ''}${lens.rightSph.toFixed(2)}D</span>
                                        </div>
                                        ${lens.rightCyl && lens.rightCyl !== 0 ? `
                                        <div class="flex justify-between">
                                            <span>CYL:</span>
                                            <span class="font-mono font-bold">${lens.rightCyl.toFixed(2)}D</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>AX:</span>
                                            <span class="font-mono font-bold">${lens.rightAxis}¬∞</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                                
                                <div class="bg-white/60 p-3 rounded-xl">
                                    <h5 class="text-xs font-semibold text-gray-600 mb-2">Â∑¶Áúº (OS)</h5>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>SPH:</span>
                                            <span class="font-mono font-bold">${lens.leftSph >= 0 ? '+' : ''}${lens.leftSph.toFixed(2)}D</span>
                                        </div>
                                        ${lens.leftCyl && lens.leftCyl !== 0 ? `
                                        <div class="flex justify-between">
                                            <span>CYL:</span>
                                            <span class="font-mono font-bold">${lens.leftCyl.toFixed(2)}D</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>AX:</span>
                                            <span class="font-mono font-bold">${lens.leftAxis}¬∞</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${lens.add > 0 ? `
                            <div class="mt-3 bg-orange-100 p-3 rounded-xl">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-semibold text-orange-800">Âä†ÂÖ•Â∫¶Êï∞ (ADD):</span>
                                    <span class="font-mono font-bold text-orange-800">+${lens.add.toFixed(2)}D</span>
                                </div>
                            </div>` : ''}
                        </div>`;
                });
                
                resultsHTML += `</div></div>`;

                // „Ç¢„Éâ„Éê„Ç§„ÇπË°®Á§∫ÔºàADDÂØæÂøúÔºâ
                const advice = generateAdvice(prescription);
                resultsHTML += `
                <div class="prescription-card rounded-3xl shadow-xl p-6 border border-cyan-100">
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-gradient-to-r from-cyan-400 to-blue-400 rounded-lg mr-3">
                            <div class="w-5 h-5 text-white flex items-center justify-center">üí°</div>
                        </div>
                        <h2 class="text-xl font-semibold">È´òÁ≤æÂ∫¶Âá¶Êñπ„Ç¢„Éâ„Éê„Ç§„ÇπÔºàADDÂØæÂøúÔºâ</h2>
                    </div>
                    
                    <div class="space-y-3">`;
                
                advice.forEach((item, index) => {
                    resultsHTML += `
                        <div class="bg-gradient-to-r from-cyan-50 to-blue-50 p-3 rounded-2xl border border-cyan-200">
                            <p class="text-sm text-gray-700">${item}</p>
                        </div>`;
                });
                
                resultsHTML += `</div></div>`;
                
                if (resultsColumn) {
                    resultsColumn.innerHTML = resultsHTML;
                }
            } catch (error) {
                console.error('ÁµêÊûúË°®Á§∫„Ç®„É©„Éº:', error);
                alert('ÁµêÊûúË°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        // „É¨„É≥„Ç∫Êé®Â•®ÁîüÊàêÔºàADDÂØæÂøúÔºâ
        function generateLensRecommendations(prescription) {
            let lensRecommendations = [];
            
            // ÈÅ†Áî®ÂçòÁÑ¶ÁÇπ
            lensRecommendations.push({
                type: "ÈÅ†Áî®ÂçòÁÑ¶ÁÇπ",
                rightSph: prescription.right.sph,
                leftSph: prescription.left.sph,
                rightCyl: prescription.right.cyl,
                leftCyl: prescription.left.cyl,
                rightAxis: prescription.right.axis,
                leftAxis: prescription.left.axis,
                add: 0,
                distance: "ÈÅãËª¢„Éª„Çπ„Éù„Éº„ÉÑ„ÉªÈÅ†Êñπ‰ΩúÊ•≠",
                note: "ÈÅ†ÊñπË¶ñÂäõÈáçË¶ñ„ÄÅ„ÇØ„É™„Ç¢„Å™ÈÅ†ÊñπË¶ñ"
            });
            
            // ËÄÅË¶ñ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆËøΩÂä†„É¨„É≥„Ç∫
            if (prescription.age >= 40 && prescription.addPower > 0) {
                // ËøëÁî®ÂçòÁÑ¶ÁÇπ
                lensRecommendations.push({
                    type: "ËøëÁî®ÂçòÁÑ¶ÁÇπ",
                    rightSph: prescription.right.sph + prescription.addPower,
                    leftSph: prescription.left.sph + prescription.addPower,
                    rightCyl: prescription.right.cyl,
                    leftCyl: prescription.left.cyl,
                    rightAxis: prescription.right.axis,
                    leftAxis: prescription.left.axis,
                    add: 0,
                    distance: "Ë™≠Êõ∏„ÉªËøë‰ΩúÊ•≠Â∞ÇÁî®",
                    note: "ËøëÊñπÂ∞ÇÁî®„ÄÅÁúºÁ≤æÁñ≤Âä¥ËªΩÊ∏õ"
                });
                
                // ÈÅ†Ëøë‰∏°Áî®
                lensRecommendations.push({
                    type: "ÈÅ†Ëøë‰∏°Áî®",
                    rightSph: prescription.right.sph,
                    leftSph: prescription.left.sph,
                    rightCyl: prescription.right.cyl,
                    leftCyl: prescription.left.cyl,
                    rightAxis: prescription.right.axis,
                    leftAxis: prescription.left.axis,
                    add: prescription.addPower,
                    distance: "ÈÅ†Êñπ„ÄúËøëÊñπÂÖ®Âüü",
                    note: "Ê®ôÊ∫ñÁöÑ„Å™Á¥ØÈÄ≤„É¨„É≥„Ç∫„ÄÅÂÖ®Ë∑ùÈõ¢ÂØæÂøú"
                });
            }
            
            return lensRecommendations;
        }

        // „Ç¢„Éâ„Éê„Ç§„ÇπÁîüÊàêÔºàADDÂØæÂøúÔºâ
        function generateAdvice(prescription) {
            let advice = [];
            
            // ADDÈñ¢ÈÄ£„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ
            if (prescription.addPower > 0) {
                advice.push(`„ÄêÂä†ÂÖ•Â∫¶Êï∞ÂØæÂøú„Äë${prescription.age}Ê≠≥„ÅÆÊé®Â•®ADDÔºà+${prescription.addPower.toFixed(2)}DÔºâ„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü„ÄÇËÄÅË¶ñ„ÅÆÈÄ≤Ë°å„Å´Âêà„Çè„Åõ„Å¶1-2Âπ¥ÊØé„ÅÆÂÆöÊúüÁöÑ„Å™Â∫¶Êï∞Ë™øÊï¥„ÅåÂøÖË¶Å„Åß„Åô`);
                
                // Á¥ØÈÄ≤„É¨„É≥„Ç∫„ÅÆÊé®Â•®
                if (prescription.chiefComplaints.includes(1) && prescription.chiefComplaints.includes(2)) {
                    advice.push("ÈÅ†Êñπ„ÉªËøëÊñπ‰∏°Êñπ„ÅÆ‰∏ªË®¥„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅÈÅ†Ëøë‰∏°Áî®„É¨„É≥„Ç∫„ÇíÁ¨¨‰∏ÄÊé®Â•®„Å®„Åó„Åæ„Åô„ÄÇÊÖ£„Çå„Å´2-3ÈÄ±Èñì„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô");
                } else if (prescription.chiefComplaints.includes(2) || prescription.chiefComplaints.includes(3)) {
                    advice.push("PC‰ΩúÊ•≠„ÉªËøëÊñπ‰ΩúÊ•≠„Åå‰∏ª‰Ωì„ÅÆ„Åü„ÇÅ„ÄÅ‰∏≠Ëøë‰∏°Áî®„É¨„É≥„Ç∫„ÇÇÊ§úË®é„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„ÄÇ„Éá„Çπ„ÇØ„ÉØ„Éº„ÇØ„Åß„ÅÆÂø´ÈÅ©ÊÄß„ÅåÂêë‰∏ä„Åó„Åæ„Åô");
                }
            }
            
            // ‰∏ªË®¥AÔºàÈÅ†ÊñπÈáçË¶ñÔºâ„ÅÆÁâπÂà•Âá¶ÁêÜ„Ç¢„Éâ„Éê„Ç§„Çπ
            const isDistanceVisionPriority = prescription.chiefComplaints.length > 0 && prescription.chiefComplaints[0] === 1;
            if (isDistanceVisionPriority) {
                if (!prescription.hasKB) {
                    advice.push("„Äê‰∏ªË®¥AÔºöÈÅ†ÊñπÈáçË¶ñ„ÄëÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅÆ80%„ÅßÂá¶Êñπ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÈÅ†ÊñπË¶ñÂäõ„ÇíÂÑ™ÂÖà„Åó„Å§„Å§„ÄÅÊÖ£„Çå„ÇÑ„Åô„Åï„ÇíÈÖçÊÖÆ„Åó„ÅüÂá¶Êñπ„Åß„Åô");
                } else {
                    advice.push("„Äê‰∏ªË®¥AÔºöÈÅ†ÊñπÈáçË¶ñ„ÄëKB„Åã„Çâ4ÊÆµÈöéÔºà1.00DÔºâ‰ª•ÂÜÖ„Åã„Å§ÂÆåÂÖ®ÁüØÊ≠£ÂÄ§„ÅÆ80%„ÇíÁõÆÊ®ô„Å®„Åó„ÅüÂá¶Êñπ„Åß„Åô„ÄÇÈÅãËª¢Á≠â„ÅÆÈÅ†ÊñπË¶ñ„Å´ÈÖçÊÖÆ„Åó„Å¶„ÅÑ„Åæ„Åô");
                }
            }
            
            // Âü∫Êú¨ÁöÑ„Å™Âá¶Êñπ„Ç¢„Éâ„Éê„Ç§„Çπ
            if (!prescription.hasKB) {
                advice.push("ÂàùÂõûÁúºÈè°Âá¶Êñπ„ÅÆ„Åü„ÇÅ„ÄÅ‰π±Ë¶ñËª∏ÊñπÂêëÂà•Âá¶ÊñπÊ≥ïÂâá„Å´Âü∫„Å•„ÅÑ„Å¶ÊÆµÈöéÁöÑ„Å™Â∫¶Êï∞Ë™øÊï¥„ÇíË°å„Å£„Å¶„ÅÑ„Åæ„Åô");
            }
            
            // ‰π±Ë¶ñËª∏ÊñπÂêëÂà•„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ
            const rightAxisType = getAstigmatismType(prescription.right.axis);
            const leftAxisType = getAstigmatismType(prescription.left.axis);
            
            if (rightAxisType === 'direct' || leftAxisType === 'direct') {
                advice.push("Áõ¥‰π±Ë¶ñÔºà180Â∫¶ÊñπÂêëÔºâ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁõÆ„ÇíÁ¥∞„ÇÅ„Çå„Å∞Ë¶ã„Åà„Çã„Åü„ÇÅ„ÄÅÈÅïÂíåÊÑü„ÇíÊúÄÂ∞èÈôê„Å´Êäë„Åà„Åü‰øùÂÆàÁöÑ„Å™Âá¶Êñπ„Åß„Åô");
            }
            if (rightAxisType === 'inverse' || leftAxisType === 'inverse') {
                advice.push("ÂÄí‰π±Ë¶ñÔºà90Â∫¶ÊñπÂêëÔºâ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁõÆ„ÇíÁ¥∞„ÇÅ„Å¶„ÇÇË¶ã„Åà„Å´„Åè„ÅÑ„Åü„ÇÅ„ÄÅÈÅ©Âàá„Å™‰π±Ë¶ñÂá¶Êñπ„ÇíË°å„Å£„Å¶„ÅÑ„Åæ„Åô");
            }
            if (rightAxisType === 'oblique' || leftAxisType === 'oblique') {
                advice.push("Êñú‰π±Ë¶ñ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂπ≥Ë°°ÊÑüË¶ö„Å∏„ÅÆÂΩ±Èüø„ÇíËÄÉÊÖÆ„Åó„ÄÅËª∏Â∫¶Â§âÊõ¥„ÅØÈÅø„Åë„Å¶ÊÖéÈáç„Å™Âá¶Êñπ„Åß„Åô");
            }
            
            return advice.length > 0 ? advice : ["ÂÆüË∑µÁöÑ„Å™ÁúºÈè°Âá¶ÊñπÊ≥ïÂâá„Å´Âü∫„Å•„ÅèÈÅ©Âàá„Å™Âá¶Êñπ„Å´„Çà„Çä„ÄÅËâØÂ•Ω„Å™Ë¶ñÂäõ„ÅåÊúüÂæÖ„Åß„Åç„Åæ„Åô"];
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('ÂàùÊúüÂåñÈñãÂßã');
                
                // ‰∏ªË®¥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
                for (let i = 1; i <= 6; i++) {
                    try {
                        const checkbox = document.getElementById('complaint' + i);
                        if (checkbox) {
                            checkbox.addEventListener('change', function() {
                                handleComplaintChange(i);
                            });
                        }
                    } catch (error) {
                        console.error('‰∏ªË®¥„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö„Ç®„É©„Éº (complaint' + i + '):', error);
                    }
                }

                // KB„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
                try {
                    const hasKBCheckbox = document.getElementById('hasKB');
                    if (hasKBCheckbox) {
                        hasKBCheckbox.addEventListener('change', function() {
                            const kbSection = document.getElementById('kbSection');
                            if (kbSection) {
                                if (this.checked) {
                                    kbSection.classList.remove('hidden');
                                } else {
                                    kbSection.classList.add('hidden');
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('KB„Çª„ÇØ„Ç∑„Éß„É≥Ë®≠ÂÆö„Ç®„É©„Éº:', error);
                }

                // Èï∑Êäº„ÅóÊ©üËÉΩ„ÅÆË®≠ÂÆö
                try {
                    setupLongPressHandlers();
                } catch (error) {
                    console.error('Èï∑Êäº„ÅóÊ©üËÉΩË®≠ÂÆö„Ç®„É©„Éº:', error);
                }

                // Â±•Ê≠¥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
                try {
                    prescriptionHistory = JSON.parse(localStorage.getItem('prescriptionHistory')) || [];
                } catch (error) {
                    console.error('Â±•Ê≠¥„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    prescriptionHistory = [];
                }

                console.log('ÁúºÈè°Âá¶ÊñπË®àÁÆó„ÉÑ„Éº„É´ - Âä†ÂÖ•Â∫¶Êï∞ÂØæÂøúÂÆåÂÖ®Áâà ÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                alert('ÂàùÊúüÂåñ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        });
    </script>
</body>
</html>